<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>Google Maps Multiple Markers</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script
        src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
</head>
<style>
    body,
    html {
        height: 100%;
        width: 100%;
        padding: 0px;
        margin: 0px;
        font-family: Arial, Helvetica, sans-serif;
    }

    #map {
        width: 100%;
        height: 100%;
    }

    #container {
        display: flex;
        height: 800px;
        justify-content: space-between;
    }

    #header {
        padding: 10px;
        display: flex;
        flex-direction: row;
        align-content: center;
        align-items: center;
        justify-content: flex-start;
        background-color: #131d4b;
        color: white;
    }

    .inputs {
        padding: 5px;
    }
</style>

<body>

    <div id="main-container">
        <div id="header">
            <input id="searchTextField" class="inputs" placeholder="Enter a city, address or postal code">
        </div>
        <div id="container">
            <div id="map"></div>
        </div>

        <button id="drawMode">Draw Poly</button>
        <button id="deletePolygon">Delete Poly</button>
        <button id="saveData">Save data to DB</button>
    </div>

    <script type="text/javascript">

        let map;
        const input = document.getElementById('searchTextField');
        const saveDataButton = document.getElementById('saveData');
        const drawModeButton = document.getElementById('drawMode');
        const deletePolygonButton = document.getElementById('deletePolygon');

        const apiURL = 'https://serg.one/google-save-poly-api/api.php'

        let selectedShape;
        let drawingManager;
        const allShapes = [];

        async function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 4,
                center: { lat: 52.31786821583068, lng: 5.511021859039191 },
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            const geocoder = new google.maps.Geocoder()
            var options = {
                componentRestrictions: { country: "us" }
            };
            const autocomplete = new google.maps.places.Autocomplete(input);
            google.maps.event.addListener(autocomplete, 'place_changed', function (e) {
                var place = autocomplete.getPlace();
                const loc = place.geometry.location;
                map.setCenter(place.geometry.location);
                map.setZoom(8);
            });

            const drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYGON,
                drawingControl: false,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: []
                },
                polygonOptions: {
                    editable: true
                }
            });
            drawingManager.setMap(map);
            drawingManager.setDrawingMode(null);

            google.maps.event.addListener(drawingManager, 'overlaycomplete', function (e) {
                drawingManager.setDrawingMode(null);
                const newShape = e.overlay;

                newShape.setOptions({
                    clickable: true
                });
                newShape.type = e.type;
                google.maps.event.addListener(newShape, 'click', function () {
                    setSelection(newShape);
                    google.maps.event.addListener(newShape.getPath(), 'insert_at', function () {
                        console.log("allshapes index updated =", allShapes.indexOf(newShape));
                    });
                    google.maps.event.addListener(newShape.getPath(), 'set_at', function () {
                        console.log('shape coords updated', getShapeCoords(newShape));
                    });
                });
                console.log('newShape', newShape);

                allShapes.push(newShape);
                console.log("all shapes array", allShapes);
                console.log("first coords", getShapeCoords(allShapes[0]));

                //after drawing = set selected
                setSelection(newShape);
            });
            google.maps.event.addListener(drawingManager, 'drawingmode_changed', clearSelection);

            saveDataButton.addEventListener('click', () => {
                saveData()
            });

            drawModeButton.addEventListener('click', () => {
                drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
            });

            deletePolygonButton.addEventListener('click', () => {
                deleteSelectedShape();
            });

            const urlParams = getUrlVars()
            const location = urlParams.location;

            if (location) {
                geocoder.geocode({ 'address': location }, function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        map.setCenter(results[0].geometry.location);
                        map.setZoom(8);
                    }
                });
            }

            //------------Load Polygons from DB ----------------
            const polygons = await fetchPolygonsByID(urlParams.polygonid)
            if (!polygons) return;
            const bounds = new google.maps.LatLngBounds();
            polygons.geometry.map(p => {
                const polygon = new google.maps.Polygon({
                    paths: p,
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 1,
                    fillColor: '#FF0000',
                    fillOpacity: 0.35,
                    //editable: true,
                    //draggable: true,
                });
                polygon.setMap(map);
                polygon.getPath().forEach(function (latLng) {
                    bounds.extend(latLng);
                });
                google.maps.event.addListener(polygon, 'click', () => {
                    console.log('1111', polygon);
                    polygon.setEditable(true);
                });

                allShapes.push(polygon);
            })
            map.fitBounds(bounds);

        }

        function saveData() {
            const urlParams = getUrlVars()
            const polygonId = urlParams.polygonid || 0; //session id for saving data
            if (allShapes.length === 0) return;
            fetch(apiURL, {
                method: "POST",
                body: JSON.stringify({
                    polygonId: polygonId,
                    polygons: allShapes.map(shape => getShapeCoords(shape))
                })
            })
                .then(res => res.json())
                .then(data => {
                    console.log('data', data);
                    if (!data.id) return;
                    window.history.pushState('', '', '?polygonid=' + data.id);
                })

        }

        //make no selection
        function clearSelection() {
            if (selectedShape) {
                selectedShape.setEditable(false);
                selectedShape = null;
            }
        }
        //set selection to a shape
        function setSelection(shape) {
            clearSelection();
            selectedShape = shape;
            shape.setEditable(true);
        }
        //delete selected shape
        function deleteSelectedShape() {
            if (!selectedShape) return;
            const index = allShapes.indexOf(selectedShape);
            allShapes.splice(index, 1);
            selectedShape.setMap(null);
            console.log("allshapes after removing one", allShapes);
        }
        //get path coords
        function getShapeCoords(shape) {
            var path = shape.getPath();
            var coords = [];
            for (var i = 0; i < path.length; i++) {
                coords.push({
                    lat: path.getAt(i).lat(),
                    lng: path.getAt(i).lng()
                });
            }
            return coords;
        }

        function getUrlVars() {
            const params = new Proxy(new URLSearchParams(window.location.search), {
                get: (searchParams, prop) => searchParams.get(prop),
            });
            return params;
        }

        async function fetchPolygonsByID(polygonId) {
            if (!polygonId) return;
            return fetch(apiURL + "?id=" + polygonId)
                .then(res => res.json())
                .then(data => {
                    console.log(data);
                    return data;
                })
        }

    </script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB8B04MTIk7abJDVESr6SUF6f3Hgt1DPAY&callback=initMap&libraries=places,drawing,geometry&v=weekly"
        async></script>

</body>

</html>